<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Mr Beast Views</title>
<style>

/* Body & general */
body {
  background-color: rgb(29, 43, 58);
  color: white;
  font-family: Arial, Helvetica, sans-serif;
  margin-left: 15px;
  margin-top: 0px;
  box-sizing: border-box;
}

/* Page main title */
#title {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 80px;
}

/* Container holding form and plot side-by-side */
#formplot {
  display: flex;
  gap: 20px;
  align-items: flex-start; /* align top edges */
  width: 100%;
  box-sizing: border-box;
  padding: 0 15px;
}

/* Form styles */
#form {
  flex: 0 0 220px; /* fixed width */
  border: 2px solid white;
  border-radius: 12px;
  padding: 20px;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  margin: 0; /* remove default margins */
  box-sizing: border-box;
}

#plotcontainer {
  position: relative;  /* needed for absolute positioning inside */
  flex: 1 1 auto;
  min-width: 0;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: center; /* center children horizontally */
}

#plotcontainer > h1 {
  position: absolute;
  top: 20px; /* lift it above the plot box's top border */
  left: 50%;
  transform: translateX(-50%);
  background-color: rgb(29, 43, 58); /* same as background to “cut out” behind text */
  padding: 0 10px;
  margin: 0;
  color: white;
  font-weight: bold;
  font-family: Arial, sans-serif;
  z-index: 10;
}
p{  
    padding: 15px;
    font-size: 18px;
}
strong{
    font-weight: 900;
}
#plot {
  width: 100%;
  min-height: 550px;
  border: 2px solid white;
  border-radius: 12px;
  box-sizing: border-box;
}



/* Form groups */
.form-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

label {
  margin-bottom: 6px;
  font-weight: bold;
  width: 100%;
}

input[type="number"],
input[type="date"] {
  border: 2px solid grey;
  border-radius: 3px;
  font-size: 15px;
  padding: 6px 8px;
  width: 100%;
  box-sizing: border-box;
  background-color: transparent;
  color: white;
  font-family: Arial, sans-serif;
}

input[type="number"]:focus, input[type="date"]:focus {
  border: 2px solid rgb(44, 156, 219);
  outline: none;
  border-radius: 3px;
  font-size: 15px;
  padding: 6px 8px;
  width: 100%;
  box-sizing: border-box;
  background-color: transparent;
  color: white;
  font-family: Arial, sans-serif;
}

input[type="submit"] {
  width: 100%;
  padding: 10px 0;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s ease;
}

input[type="submit"]:hover {
  background-color: #45a049;
}

#loading {
  position: fixed;        /* fixed to viewport */
  top: 0; 
  left: 0;
  width: 100vw;           /* full viewport width */
  height: 100vh;          /* full viewport height */
  background-color: rgba(99, 99, 99, 0.459); /* #4caf4f2a in rgba */
  
  justify-content: center;
  align-items: center;

  font-size: 55px;
  font-weight: 800;
  color: white;
  z-index: 9999;
  user-select: none;
  pointer-events: none;   /* optional: disable interaction while loading */
  display: none;          /* start hidden */
}

</style>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.3/plotly.min.js"></script>
<div id = "title">
    <h1>Mr. Beast views</h1>
</div>


<div id = "formplot">
    
    <div id = "plotcontainer">
        <h1> Chart</h1>
        <div id="plot"></div>
    </div>
    <form id="form">
    <div class="form-group">
        <label for="hours">Time (hours)</label>
        <input type="number" id="hours" step="any" value="0">
    </div>
    
    <div class="form-group">
        <label for="minutes">Time (minutes)</label>
        <input type="number" id="minutes" step="any" value="0">
    </div>

    <div class="form-group">
        <label for="views">Views:</label>
        <input type="number" id="views" value="0">
    </div>

    <div class="form-group">
        <label for="date">Release Date:</label>
        <input type="date" id="date" value="2025-08-16">
    </div>

    <div class="form-group">
        <label for="charity">Charity odds</label>
        <input type="number" id="charity" value="0.14" step="0.01">
    </div>

    <input type="submit" value="Submit">
    </form>
</div>

<div id = "finalOdds"></div>

<div id = "loading">
    Loading...
</div>
<script>

function timeToPercent(x){
    let L = 65.98606209690959
    let d = 32.372082402569404
    let k = 0.06287719939252132
    let x0 = -5.398947976847045
    let e = Math.E
    return (L*e**(-1*e**(-k*(x-x0))) - d)/24
}

function timeToSpreads(x){
    let a = 1.5085534391508881
    let b = 10.310613572906199
        
    return ((x*(24-x))**(1/a)*1/b)/100
}

function beta(time, min, max){
    if (min <0){
        min = 0
    }
    if (max > 1){
        max = 1
    }
    if (min > 1){
        return 0
    }
    if (time === 0){
        if (min === 0){
            return 1
        }
        return 0
    }
    if (time === 24){
        if (max === 1){
            return 1
        }
        return 0
    }
    let k_0 = timeToSpreads(time)**2
    let j = timeToPercent(time)
    let r_0 = (1-j)/j
    let alpha = (r_0/((1+r_0)**2)-k_0)/(k_0*(1+r_0))
    let beta = r_0*alpha
    function inputBeta(x){
        return (x)**(alpha-1)*(1-x)**(beta-1)
    }
    let o = integrate(inputBeta, 0, 1)
    let a = integrate(inputBeta, min, max)
    return a/o
}

let daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
function dayToExpectedViews(date){
    let year = date.getFullYear()
    let month = date.getMonth()
    let day = date.getDate()

    let daysSinceStartOf2024 = 0;

    daysSinceStartOf2024 += (year-2023)*365;
    for (let i = 0; i < month; i++) {
        daysSinceStartOf2024 += daysInMonth[i]
    }
    daysSinceStartOf2024 += day
    let x = daysSinceStartOf2024/10
    if (x>36.5){
        x -= Math.floor(x/36.5)*36.5
    }
    let r = 5.6032443170431865
    let j = 1.4467844651715271
    let n = 43.74549780750972
    return r*Math.cos(x*2*Math.PI/36.5 - Math.PI*j) + n
}
function initialDistrib(min, max){
    // normal
    let m = Math.log(dayToExpectedViews(releaseDate));
    //let m = Math.log(40);
    let s = 0.1675179877937261;

    // charity
    let d = 3.3404571586757212;
    let r = 0.2742537825689307;
    function inputLogNormal(x){
        return 1/(s*Math.sqrt(2*Math.PI))*1/x*Math.E**(-1*(Math.log(x)-m)**2/(2*s**2))
    }
    function inputCharityNormal(x){
        return 1/(r*Math.sqrt(2*Math.PI))*1/x*Math.E**(-1*(Math.log(x)-d)**2/(2*r**2))
    }
    return ((1-charityOdds)*integrate(inputLogNormal, min, max)+ charityOdds*integrate(inputCharityNormal, min, max))
}

function integrate(func, min, max){
    let n = 50_000;
    let sum = 0
    let width = (max-min)/n
    for (let i = 0; i <= n; i++) {
        let x = min+width*i
        let multiplier;
        if (i === 0 || i===n){
            multiplier = 1
        } else if (i%2 === 1){
            multiplier = 4
        } else{
            multiplier = 2
        }
        sum+=multiplier*func(x)*width/3
    }
    return sum
}
let time;
let numViews;
let releaseDate;
let charityOdds;

let minViews = 5;
let maxViews = 110;

let brackets = [
    [minViews, 25],
    [25, 30],
    [30, 35],
    [35, 40],
    [40, 45],
    [45, 50],
    [50, 55],
    [55, maxViews]
]
let bracketedResults = []
function calcOdds(){
    let possibilities = [];
    let bucketSize = 0.1
    for (let i = minViews; i < maxViews; i+=bucketSize) {
        
        let prior = initialDistrib(i, i+bucketSize)
        multiplier = 1/((i+bucketSize/2)*1_000_000)
        let betaResult = beta(time, (numViews*0.999)*multiplier, (numViews*1.001)*multiplier)
        possibilities.push(prior*betaResult)

    }
    let totalp = 0
    for (let i = 0; i < possibilities.length; i++) {
        totalp+=possibilities[i]
    }
    for (let i = 0; i < possibilities.length; i++) {
        possibilities[i] = possibilities[i]/totalp
    }

    let lumpedPossibilities = []

    let sums = 0
    let mod = 5/bucketSize
    for (let i = 0; i < possibilities.length; i++) {
        sums += possibilities[i]
        if (i%mod === mod-1){
            lumpedPossibilities.push([(i-mod+1)*bucketSize+minViews, (i+1)*bucketSize+minViews, sums])
            sums = 0
        }
    }
    bracketedResults = [];
    for (let i = 0; i < brackets.length; i++) {
        bracketedResults.push(0)
    }
    console.log(lumpedPossibilities)
    for (let i = 0; i < lumpedPossibilities.length; i++) {
        let lumpedPossi = lumpedPossibilities[i];
        let lumpedPossiMin = lumpedPossi[0];
        let lumpedPossiMax = lumpedPossi[1];
        let lumpedPossiOdds = lumpedPossi[2];
        for (let j = 0; j < brackets.length; j++) {
            let bracket = brackets[j]
            let bracketMin = bracket[0];
            let bracketMax = bracket[1];
            if (lumpedPossiMin >= bracketMin && lumpedPossiMax <= bracketMax){
                bracketedResults[j] += lumpedPossiOdds
                break
            }
        }
    }

    let container = document.getElementById("finalOdds");
    container.innerHTML = ""
    let text = ""
    for (let i = 0; i < brackets.length; i++) {
        let bracketMin = brackets[i][0]
        let bracketMax = brackets[i][1];
        text += "[" + bracketMin + ",  " + bracketMax + "): <strong>" + Math.round(bracketedResults[i]*10000)/100 + "%</strong>, "
    }
    let newElement = document.createElement("p");
    newElement.innerHTML = text.slice(0,-2)
    container.appendChild(newElement)

    let x1 = [];
    let y1 = [];
    let x2 = [];
    let y2 = [];
    for (let i = 0; i < possibilities.length; i += 1) {
        x1.push(i*bucketSize+minViews+bucketSize/2);
        y1.push(possibilities[i]*100*1/bucketSize);
    }
    
    for (let i = 0; i < Math.round(possibilities.length/5*bucketSize); i += 1) {
        x2.push(i*5+minViews+2.5);
        y2.push(lumpedPossibilities[i][2]*100);
    }
    let layout = {
        font: { family: 'Arial, sans-serif', size: 16, color: 'white' },
        paper_bgcolor: 'rgb(29, 43, 58);',
        plot_bgcolor: 'rgb(29, 43, 58);',
        showlegend: false
    }
    let baseline = -0.05;

let baselineTrace = {
  x: x1,
  y: x1.map(_ => baseline),  // horizontal line at y = baseline
  mode: 'lines',
  line: {color: 'rgba(0,0,0,0)'},
  showlegend: false,
  hoverinfo: 'skip'
};
    Plotly.newPlot('plot', 
        [baselineTrace,
            {
                x: x1,
                y: y1,
                type: 'scatter',
                mode: "line",
                fill: "tonexty",
                fillcolor: 'rgb(31, 119, 180)', // semi-transparent fill color
                line: {color: 'rgb(31, 119, 180)'},
                name: 'Odds'
            },
            {
                x: x2,
                y: y2,
                type: 'bar',
                marker: {color: 'rgb(255, 127, 14)'}, 
                name: 'Odds (bucketed)'
            }
        ],
        layout
    );
}



let form = document.getElementById('form');

form.addEventListener('submit', function(event) {
    
    audio.play();
    event.preventDefault(); // Prevent page reload
    document.getElementById("loading").style.display = "flex";
    setTimeout(function(){
let hours = Number(document.getElementById("hours").value)
    let minutes = Number(document.getElementById("minutes").value)
    time = hours + minutes/60
    numViews = Number(document.getElementById("views").value)
    releaseDate = new Date(document.getElementById("date").value)
    charityOdds = Number(document.getElementById("charity").value)
    calcOdds()
    document.getElementById("loading").style.display = "none";
    }, 10)
    
});

//music
let playlist = [
    "Ahrix%20-%20Nova%20[NCS%20Release].mp3",
    "Elektronomia%20-%20Sky%20High%20[NCS%20Release].mp3",
    "Lost%20Sky%20-%20Dreams%20[NCS%20Release].mp3",
    "Tobu%20-%20Colors.mp3",
    "Unity%20Instrumental.mp3",
    "Fade.mp3",
    "Different%20Heaven%20-%20Nekozilla%20[NCS%20Release].mp3",
    "HeroesTonight.mp3",
    "circles.mp3",
    "coffin.mp3",
    "Unknown%20Brain,%20Chris%20Linton%20-%20Superhero%20(feat.%20Chris%20Linton)%20[NCS%20Release]%20(1).mp3"
];
let randomisedPlaylist = [];
let n = playlist.length
for (let i = 0; i < n; i++) {
    let r = playlist.length;
    let random = Math.floor(Math.random()*r)
    randomisedPlaylist.push(playlist[random]);
    playlist = playlist.slice(0, random).concat(playlist.slice(random+1))
}
let currentSong = Math.floor(Math.random()*randomisedPlaylist.length);
let audio = new Audio(randomisedPlaylist[currentSong]);
audio.addEventListener("ended", function() {
    nextSong()
});
function nextSong(){
    currentSong = (currentSong + 1) % randomisedPlaylist.length;
    audio.src = randomisedPlaylist[currentSong];
    audio.play();
}
</script>
</body>
</html>
